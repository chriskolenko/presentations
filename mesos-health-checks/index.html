<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Health Checks</title><meta name="generator" content="Hovercraft! 1.0 http://regebro.github.com/hovercraft"></meta><link rel="stylesheet" href="css/hovercraft.css" media="all"></link><link rel="stylesheet" href="css/impressConsole.css" media="all"></link><link rel="stylesheet" href="css/highlight.css" media="all"></link><link rel="stylesheet" href="site.css" media="screen,projection"></link></head><body class="impress-not-supported"><div id="impress" data-transition-duration="1500"><div class="step step-level-1" step="0" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="0" data-y="0" data-z="0"><h1 id="who-am-i">Who am I?</h1><h2 id="chris-kolenko-cba-software-engineer">Chris Kolenko | CBA Software Engineer</h2><div class="notes"><p>Talk about hobbies, family</p></div></div><div class="step step-level-1" step="1" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="1600" data-y="0" data-z="0"><h1 id="why-am-i-presenting">Why am I presenting?</h1><ul><li>Mesos native health checks is new (1.1.0 - 1.2.0)</li><li>Marathon Load Balancer</li><li>Masters couldn't connect to workloads</li></ul><div class="notes"><p>Stephan asked if I was willing to give a presentation, since it was a new feature.</p><p>I stubbled across this new feature trying to make Marathon LB work correctly for my App.</p><p>When trying Marathon HTTP it didn't work (because of our network). Which was good because I didn't really know what it was going to do.</p></div></div><div class="step step-level-1" step="2" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="3200" data-y="0" data-z="0"><h1 id="what-is-a-health-check">What is a health check?</h1><p>In very simple terms it's a pass or fail test that runs every now and then to make sure something is passing.</p><div class="notes"><p>I'll get to the framework limitations soon.</p></div></div><div class="step step-level-1" step="3" data-rotate-x="0" data-rotate-y="0" data-rotate-z="90" data-scale="1" data-x="4800" data-y="0" data-z="0"><h1 id="what-type-of-health-checks">What type of health checks?</h1><ul><li>HTTP/HTTPS</li><li>TCP</li><li>Command</li></ul><div class="notes"><p>HTTP/HTTPS like the internet</p><p>TCP check if port is in use</p><p>Command will run a command against inside the task</p></div></div><div class="step step-level-1" step="4" data-rotate-x="0" data-rotate-y="0" data-rotate-z="90" data-scale="1" data-x="6400" data-y="0" data-z="0"><h1 id="what-are-the-important-settings">What are the important settings?</h1><ul><li>path (/api/health)</li><li>protocol (HTTPS/HTTP)</li><li>gracePeriodSeconds (300 seconds)</li><li>intervalSeconds</li><li>timeoutSeconds</li><li>maxConsecutiveFailures</li></ul><div class="notes"><p>gracePeriodSeconds ignore failures until either success or after 300 secs</p><p>intervalSeconds wait inbetween checks</p><p>timeoutSeconds if reached == failed</p><p>maxConsecutiveFailures number of fails in a row before TASK isn't health</p></div></div><div class="step step-level-1" step="5" data-rotate-x="0" data-rotate-y="0" data-rotate-z="90" data-scale="1" data-x="8000" data-y="0" data-z="0"><h1 id="can-i-have-multiple-health-checks">Can I have multiple health checks?</h1><p>YES!</p><div class="notes"><p>Just here so no one has to ask</p></div></div><div class="step step-level-1" step="6" data-rotate-x="0" data-rotate-y="0" data-rotate-z="90" data-scale="1" data-x="9600" data-y="0" data-z="0"><h1 id="why-mesos-added-native-hc">Why Mesos added native HC?</h1><ul><li>Most frameworks where creating their own</li><li>Frameworks had limitations</li><li>Here's the doc: <a href="https://github.com/apache/mesos/blob/master/docs/health-checks.md">https://github.com/apache/mesos/blob/master/docs/health-checks.md</a></li></ul><div class="notes"><p>I'll get to the framework limitations soon.</p></div></div><div class="step step-level-1" step="7" data-rotate-x="0" data-rotate-y="0" data-rotate-z="90" data-scale="1" data-x="11200" data-y="0" data-z="0"><h1 id="marathon-health-checks">Marathon Health Checks</h1><p>As of 1.4 Marathon Health Checks are deprecated. Why?</p><p>A blog post from Mesosphere = <a href="https://mesosphere.com/blog/2017/01/05/introducing-mesos-native-health-checks-apache-mesos-part-1/">https://mesosphere.com/blog/2017/01/05/introducing-mesos-native-health-checks-apache-mesos-part-1/</a></p><div class="notes"><p>Marathon did some benchmarking and found:</p><p>HTTP checks start to fail after ~1900 tasks</p><p>TCP was a little better but problems started at ~3700</p><p>Mesos native scaled linearly to 4500 tasks</p><p>The health state is not available via the Mesos state</p><p>Marathon has to share the same network as the tasks to monitor, so it can reach all launched tasks</p></div></div><div class="step step-level-1" step="8" data-rotate-x="0" data-rotate-y="0" data-rotate-z="90" data-scale="1" data-x="12800" data-y="0" data-z="0"><h1 id="where-do-they-run">Where do they run?</h1><p>Mesos native == on the agent
Marathon == from marathon to the task</p><div class="notes"><p>More about native next</p></div></div><div class="step step-level-1" step="9" data-rotate-x="0" data-rotate-y="0" data-rotate-z="90" data-scale="1" data-x="14400" data-y="0" data-z="0"><h1 id="but-how-does-it-actually-work">But how does it actually work?</h1><p>The health check enters the network namespace before running a curl command. (HTTP/HTTPS or TCP only)</p><p>Docker run is used for commands</p><div class="notes"><p>Limitations; HTTP/HTTPS and TCP run checks against 127.0.0.1</p><p>Command might have issues try using Mesos 1.2.0</p><p>Enter network namespace via setns command</p></div></div><div class="step step-level-1" step="10" data-rotate-x="0" data-rotate-y="0" data-rotate-z="90" data-scale="1" data-x="16000" data-y="0" data-z="0"><h1 id="marathon-json">Marathon JSON</h1><pre class="highlight code bash"><span class="s2">"healthChecks"</span>: <span class="o">[{</span>
  <span class="s2">"port"</span>: <span class="m">22</span>,
  <span class="s2">"protocol"</span>: <span class="s2">"MESOS_TCP"</span>,
  <span class="s2">"gracePeriodSeconds"</span>: <span class="m">300</span>,
  <span class="s2">"intervalSeconds"</span>: <span class="m">60</span>,
  <span class="s2">"timeoutSeconds"</span>: <span class="m">20</span>,
  <span class="s2">"maxConsecutiveFailures"</span>: <span class="m">0</span>
<span class="o">}]</span>,</pre><div class="notes"><p>Only works via REST API</p></div></div><div class="step step-level-1" step="11" data-rotate-x="0" data-rotate-y="0" data-rotate-z="90" data-scale="1" data-x="17600" data-y="0" data-z="0"><h1 id="healthy">Healthy!</h1><img src="images/healthy.png"></img></div><div class="step step-level-1" step="12" data-x="0" data-y="2500" data-z="4000" data-rotate-x="90" data-rotate-y="0" data-rotate-z="90" data-scale="1"><h1 id="questions">Questions?</h1></div></div><div id="hovercraft-help"><table><tr><th>Space</th><td>Forward</td></tr><tr><th>Right, Down, Page Down</th><td>Next slide</td></tr><tr><th>Left, Up, Page Up</th><td>Previous slide</td></tr><tr><th>P</th><td>Open presenter console</td></tr><tr><th>H</th><td>Toggle this help</td></tr></table></div><script type="text/javascript" src="js/impress.js"></script><script type="text/javascript" src="js/impressConsole.js"></script><script type="text/javascript" src="js/hovercraft.js"></script></body></html>